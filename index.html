<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sensor Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0"></script>
  <style>
    body {
      background-color: #e0f7fa;
    }

    .navbar {
      background-color: #00796b;
    }

    .navbar a {
      color: white;
      padding: 10px 15px;
      font-weight: bold;
      border-radius: 5px;
      transition: background-color 0.3s ease;
    }

    .navbar a:hover {
      background-color: #004d40;
    }

    .sensor-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
    }

    .sensor-card h3 {
      color: #00796b;
      font-size: 1.1rem;
    }

    .sensor-card p {
      color: #555;
    }

    .dashboard-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      margin-top: 1.5rem;
    }

    .text-muted {
      color: #9e9e9e;
    }
  </style>
</head>
<body class="p-6">
  <!-- Navbar -->
  <div class="navbar flex justify-between items-center p-4">
    <div class="text-xl font-bold text-white">Sensor Dashboard</div>
    <div class="flex space-x-4">
      <a href="#" id="overview-tab" class="bg-teal-800">Overview</a>
      <a href="#" id="sensor-data-tab">Sensor Data</a>
    </div>
  </div>

  <!-- Overview Section -->
  <div id="overview-section" class="max-w-6xl mx-auto dashboard-container p-8 mt-6">
    <h1 class="text-2xl font-semibold text-center mb-6">Sensor Overview</h1>
    <div id="sensor-overview-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <!-- Cards will be injected -->
    </div>
  </div>

  <!-- Sensor Data Section -->
  <div id="sensor-data-section" class="max-w-6xl mx-auto dashboard-container p-8 mt-6 hidden">
    <h1 class="text-2xl font-semibold text-center mb-6">Sensor Data Timeline</h1>
    <div id="sensor-timeline-info" class="mb-6 text-muted text-center"></div>
    <div id="sensor-charts-container" class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <!-- Charts will be injected -->
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBelbH4y_QshAkAXh3gSZwR4D_0zZB4JlE",
      authDomain: "iot-hydro-d5464.firebaseapp.com",
      databaseURL: "https://iot-hydro-d5464-default-rtdb.firebaseio.com",
      projectId: "iot-hydro-d5464",
      storageBucket: "iot-hydro-d5464.appspot.com",
      messagingSenderId: "385611702191",
      appId: "1:385611702191:web:1ed53fe09216d50f68595a"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const fetchSensorData = async () => {
      const snapshot = await db.ref("sensor_data").orderByChild("created_at").limitToLast(10).once("value");
      const sensorData = snapshot.val();

      if (sensorData) {
        const dataArr = Object.values(sensorData).reverse();
        renderOverview(dataArr[0]);
        renderSensorDataTimeline(dataArr);
        initializeCharts(dataArr);
      } else {
        console.warn("No sensor data available.");
      }
    };

    const renderOverview = (data) => {
      const container = document.getElementById("sensor-overview-content");
      container.innerHTML = `
        ${createCard("Temperature (°C)", `${data.temperature}°C`, data.created_at)}
        ${createCard("Humidity (%)", `${data.humidity}%`, data.created_at)}
        ${createCard("Soil Moisture (%)", `${data.soil_moisture}%`, data.created_at)}
        ${createCard("Water Level (%)", `${data.water_level}%`, data.created_at)}
      `;
    };

    const createCard = (title, value, timestamp) => `
      <div class="sensor-card">
        <h3>${title}</h3>
        <p class="text-2xl font-bold">${value}</p>
        <p class="text-sm text-muted">Last updated: ${new Date(timestamp).toLocaleString()}</p>
      </div>
    `;

    const renderSensorDataTimeline = (dataArr) => {
      const info = document.getElementById("sensor-timeline-info");
      const first = new Date(dataArr[dataArr.length - 1].created_at).toLocaleString();
      const last = new Date(dataArr[0].created_at).toLocaleString();
      info.innerHTML = `Showing last ${dataArr.length} readings (from ${first} to ${last})`;
    };

    const initializeCharts = (dataArr) => {
      const container = document.getElementById("sensor-charts-container");
      container.innerHTML = ""; // Clear

      const sensors = [
        { key: "temperature", label: "Temperature (°C)", color: "#FF5733" },
        { key: "humidity", label: "Humidity (%)", color: "#33FF57" },
        { key: "soil_moisture", label: "Soil Moisture (%)", color: "#3357FF" },
        { key: "water_level", label: "Water Level (%)", color: "#FFD700" },
      ];

      sensors.forEach(({ key, label, color }) => {
        const canvas = document.createElement("canvas");
        container.appendChild(canvas);

        new Chart(canvas, {
          type: "line",
          data: {
            datasets: [{
              label: label,
              data: dataArr.map(entry => ({
                x: new Date(entry.created_at),
                y: entry[key]
              })),
              borderColor: color,
              backgroundColor: `${color}20`,
              borderWidth: 2,
              tension: 0.3,
              fill: true
            }]
          },
          options: {
            responsive: true,
            scales: {
              x: {
                type: 'time',
                time: {
                  unit: 'minute',
                  tooltipFormat: 'MMM d, yyyy HH:mm'
                },
                title: { display: true, text: 'Time' }
              },
              y: {
                title: { display: true, text: 'Value' },
                beginAtZero: true
              }
            }
          }
        });
      });
    };

    // Tab Navigation
    const showOverview = () => {
      document.getElementById("overview-section").classList.remove("hidden");
      document.getElementById("sensor-data-section").classList.add("hidden");
      document.getElementById("overview-tab").classList.add("bg-teal-800", "text-white");
      document.getElementById("sensor-data-tab").classList.remove("bg-teal-800", "text-white");
    };

    const showSensorData = () => {
      document.getElementById("sensor-data-section").classList.remove("hidden");
      document.getElementById("overview-section").classList.add("hidden");
      document.getElementById("sensor-data-tab").classList.add("bg-teal-800", "text-white");
      document.getElementById("overview-tab").classList.remove("bg-teal-800", "text-white");
    };

    document.getElementById("overview-tab").addEventListener("click", (e) => {
      e.preventDefault();
      showOverview();
    });

    document.getElementById("sensor-data-tab").addEventListener("click", (e) => {
      e.preventDefault();
      showSensorData();
    });

    fetchSensorData();
  </script>
</body>
</html>
